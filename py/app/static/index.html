<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Crypto Dashboard</title>

 <link rel="icon" href="data:,">
  <!-- GridStack -->
  <link href="https://cdn.jsdelivr.net/npm/gridstack@9.2.1/dist/gridstack.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/gridstack@9.2.1/dist/gridstack-all.js"></script>

  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <!-- PLOT -->

  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <link rel="stylesheet" href="/static/css/styles.css"> 
   <script src="/static/js/indicators.js"></script>
   <script src="/static/js/chart.js"></script>
   <script src="/static/js/report.js"></script>
   <script src="/static/js/utils.js"></script>

</head>

<body>

 <!-- ðŸ”· Barra titolo -->
<div class="header">
    <div class="header-title">ðŸ“ˆ Crypto Live</div>
    <div class="header-status">
      Ultimo aggiornamento:
      <span id="heartbeatLabel">â€”</span>
    </div>
</div>

<button onclick="addTopVolume()">âž• Top Volume</button>
<button onclick="layout_addWidget({'type':'chart','symbol': 'BTC/USDC', 'timeframe':'1m'})">âž• BTC 1m</button>

<div class="grid-stack"></div>

<div id="popup" style="display:none;
    position:fixed; top:50%; left:50%;
    transform:translate(-50%,-50%);
    border:1px solid #ccc;
    padding:20px;
    z-index: 100;
    background:white;">
  
  <select id="choice"></select><br><br>
  <button id="ok">OK</button>
  <button id="cancel">Annulla</button>
</div>

<!-------------------------------------------->
<script>

const heartbeatLabel = document.getElementById("heartbeatLabel");
chart_list=[];
chart_map=[];
widget_list=[];
report_map=[];

// ===========  EVENTS =============

const ws = new WebSocket("ws://127.0.0.1:8000/ws/live");
ws.onmessage = (event) => {
  //console.log(event.data)
  const msg = JSON.parse(event.data);
  //console.log(msg)
  if (msg.type === "comp") {
      //console.log("comp",msg)
      if (msg.widget.type =="chart")
      {
         addCandleWidget(msg.id, msg.widget.symbol,msg.widget.timeframe,msg.widget.plot_config, msg.rect )
      }
      else if (msg.widget.type =="report")
      {
         //console.log("report")
         addReportWidget(msg.id,msg.rect ,  msg.widget)
      }
  }
  else if (msg.type === "del") {
      
       const chartObj = chart_list[msg["id"]];
       console.log("del",msg,chartObj)
        chartObj.widget_ele.classList.add('closing');
        setTimeout(() => grid.removeWidget(chartObj.widget_ele), 200);
       
  }
  else if (msg.type === "candle") {
    //console.log("ðŸ•¯ï¸ nuova candle", msg);
    const id = msg.id;
    const symbol = msg.symbol;
    const chartObj = chart_list[id];

    if (!chartObj) {
        console.warn("Grafico non trovato per", symbol);
        return;
    }
    
    const c = msg.data;
    
    //console.log("update" ,c)
    chartObj.mainSeries.update({
        //time: Math.floor(c.timestamp / 1000), // âš ï¸ seconds
        time: db_localTime(c.t),
        open: c.o,
        high: c.h,
        low: c.l,
        close: c.c,
        volume:c.v,
    });
    chartObj.volumeSeries.update({
        time: db_localTime(c.t),
        value: c.bv,
        color: c.c >= c.o ? '#4bffb5aa' : '#ff4976aa'
    });
  }
  else  if (msg.type === "report") {
      
      const reportObj = report_map[msg["id"]];
      console.log("report ..", msg,reportObj);
      reportObj.update(msg.data)
  }
  else if (msg.type === "heartbeat") {
        const d = new Date(msg.ts);
        heartbeatLabel.textContent = d.toLocaleString();
  }
};
 $(document).ready(function () {
    setTimeout(() => 
    { 
      fetch(`/api/layout/select`)
        .then(r => r.json())
        .then(data => {
          //alert(data)
        });
      });
    },200);

// =============== GRID SETUP ==============================

const grid = GridStack.init({ 
    draggable: { handle: '.grid-stack-handle'},
    resizable: { handles: "e, se, s" },
    float:true 
});

function saveLayout() {
   const layout = grid.save(false); // false = senza DOM
   console.log("saveLayout",layout)
   if (layout.length !=widget_list.length )
   {
     alert("ATTENZIONE LEN WINDGET");
      return;
   }

   //alert(widget_list.length);
   save=[]
  for(i=0;i<widget_list.length;i++)
  {
     save.push({"id": widget_list[i].id, "rect": layout[i],"data": widget_list[i].save()}) 
    
  }

  console.log(save)
  fetch(`/api/layout/save`,
  {
    method: 'POST', 
    headers: { 'Content-Type': 'application/json'},
    body:  JSON.stringify(save)
  }).then(response => {
        if (!response.ok) {
            throw new Error(`Errore HTTP! Stato: ${response.status}`);
        }
    });
  
  //localStorage.setItem("grid-layout", JSON.stringify(layout));
}

grid.on("change", saveLayout);

grid.on("resizestop", (e, el) => {
  const container = el.querySelector(".chart-container");
  if (!container) return;

  const chartObj = chart_list[container.id];
  if (!chartObj) return;

  console.log(chartObj);

  for(i=0;i<chartObj.charts.length;i++)
    {
        if (i==0)
            chartObj.charts[0].resize(
                container.clientWidth,
                container.clientHeight
            );
            else
             chartObj.charts[i].resize(
                container.clientWidth,
                100
            );
    }
});

// ============== WIDGETS ===========================

function layout_closeWidget(item,id)
{
  //console.log("id",id)
  if (confirm('Chiudere il widget?')) {
    //#item.classList.add('closing');
    //setTimeout(() => grid.removeWidget(item), 200);
     fetch(`/api/layout/cmd`,
    {
      method: 'POST', 
      headers: { 'Content-Type': 'application/json'},
      body:  JSON.stringify({"scope" : "layout" , "cmd" :"del" , "id" : id})
    }).then(response => {
          if (!response.ok) {
              throw new Error(`Errore HTTP! Stato: ${response.status}`);
          }
      });
  }
}

function layout_addWidget(data)
{
  data.scope="layout"
  data.cmd="add"
  fetch(`/api/layout/cmd`,
  {
    method: 'POST', 
    headers: { 'Content-Type': 'application/json'},
    body:  JSON.stringify(data)
  }).then(response => {
        if (!response.ok) {
            throw new Error(`Errore HTTP! Stato: ${response.status}`);
        }
    });
}



function addWidget(title, contentHtml,rect) {
  const el = document.createElement('div');
  el.classList.add("grid-stack-item");
  el.innerHTML = `
    <div class="grid-stack-item-content">
      <h3 class="drag-handle">${title}</h3>
      <div class="no-drag">
            ${contentHtml}
        </div>
    </div>
  `;
    /*
  el.innerHTML1 = `
    <div class="grid-stack-item">
      <div class="grid-stack-item-content">
        <h3 class="drag-handle">${title}</h3>
        <div class="no-drag">
            ${contentHtml}
        </div>
      </div>
    </div>`;
    */
  grid.addWidget(el,rect);
}

function addTopVolume() {
  const id = "table_" + Date.now();
  addWidget("Top Volume", `<table id="${id}" class="display"></table>`);

  fetch('/api/top_volume')
    .then(r => r.json())
    .then(data => {
      $(`#${id}`).DataTable({
        data,
        columns: [
          { title:"Symbol", data:"symbol" },
          { title:"Volume", data:"volume" }
        ]
      });
    });
}


function chart_select_symbol(item,id)
{
    chartObj = chart_list[id];
    //console.log("chart_selectpair",chartObj)
    $.getJSON('/api/symbols', function (data) {
      PopupList(data["symbols"], chartObj.symbol, (newSymbol)=>
      {
        //console.log("SELTA ", newPair ,id )
        chartObj = chart_list[id];
         //console.log("chart_selectpair1",chartObj)
         chartObj.symbol = newSymbol;
         console.log(chartObj.titleElement)
         chartObj.titleElement.innerHTML = newSymbol;
         chartObj.refresh();
      } );
    });
}

function addCandleWidget(id, symbol,timeframe,plot_config,rect) {

  console.log("plot_config",plot_config)

  function updateChartTimeframe(chartId, newTimeframe) {
    chatObj = chart_list[chartId]
    console.log(`Aggiornamento del grafico ID: ${chartId} al timeframe: ${newTimeframe} chatObj ${chatObj}`);
    chatObj.timeframe = newTimeframe;
    chatObj.refresh();
  }

  function attachTimeframeListener(widgetElement) {
    const selectElement = widgetElement.querySelector('.timeframe-selector');
    const chartContainer = widgetElement.querySelector('.chart-container');
    const chartId = chartContainer ? chartContainer.id : null;

    if (selectElement && chartId) {
        selectElement.addEventListener('change', (event) => {
            const newTimeframe = event.target.value;
            updateChartTimeframe(chartId, newTimeframe);
        });
        
        // Impedisci al click sulla tendina di attivare la funzione di drag di GridStack
        selectElement.addEventListener('mousedown', (event) => {
             event.stopPropagation();
        });
    }
  }

 
  const id_chart = id;//"chart_" + Date.now();
  const id_chart_vol = id+"_vol";//chart_vol_" + Date.now();

  const el = document.createElement("div");
  el.classList.add("grid-stack-item");
  
  el.innerHTML = `
    <div class="grid-stack-item-content">
     
      <div class="header  grid-stack-handle">
        <div class="header-title">
             ðŸ“ˆ <span id='${id}_symbol'>${symbol} </span>
        </div>
        
        <button class="pair-btn" title="Select Symbol" onclick="chart_select_symbol(this.closest('.grid-stack-item'),'${id_chart}')" >^</button>
     
        <select class="timeframe-selector" >
           <option value="10s">10s</option>
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m" selected>15m</option> <option value="30m">30m</option>
            <option value="1h">1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
        </select>
      <button class="close-btn" title="Chiudi" onclick="layout_closeWidget(this.closest('.grid-stack-item'),'${id_chart}')" >âœ•</button>
        
        
    </div>
      <div class="chart-container" id="${id_chart}"></div>
    </div>
  `;
  if (rect==null)  rect =  { w: 6, h: 5 }

  grid.addWidget(el, rect  );

  el.querySelector('.timeframe-selector').value = timeframe;
  attachTimeframeListener(el);

  //createChart(id, pair, timeframe);
  setTimeout(() => {
    chartObj = createChart(el,id_chart, symbol, timeframe, plot_config);
    chartObj.titleElement = document.getElementById(id+"_symbol");

    //bind_get(chartObj.pair,id+"_pair", (val)=> { return "."+val; } );
  }, 0);
}

function addReportWidget(id, rect, data) {
  console.log("report ",data)

  const el = document.createElement("div");
  el.classList.add("grid-stack-item");
  
  el.innerHTML = `
    <div class="grid-stack-item-content">
     
      <div class="header  grid-stack-handle">
        <div class="header-title">
             ðŸ“ˆ <span id='${id}_symbol'>${data["title"]} </span>
        </div>
        
      <button class="close-btn" title="Chiudi" onclick="layout_closeWidget(this.closest('.grid-stack-item'),'${id}')" >âœ•</button>
    </div>  
        
    <table id='${id}'>
     
    </table>
  `;
  if (rect==null)  rect =  { w: 6, h: 5 }

  grid.addWidget(el, rect  );

  setTimeout(() => {
    chartObj = createReport(el,id, data);
    //chartObj.titleElement = document.getElementById(id+"_symbol");
  }, 0);

}

</script>

</body>
</html>