<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Grafico Candele</title>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        body { font-family: Arial; margin: 20px; }

        .container {
            display: flex;
            gap: 20px;
        }

        /* Colonna sinistra */
        #left {
            width: 250px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            cursor: pointer;
        }
        th, td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        tr:hover {
            background-color: #f2f2f2;
        }

        /* Colonna destra */
        #right {
            flex: 1;
        }

        #chart {
            max-width: 100%;
            height: 600px;
        }
    </style>
</head>
<body>

<h2>Dashboard Candele – 5 minuti</h2>

<div class="container">

    <!-- ==== COLONNA SINISTRA: TABELLA ID ==== -->
    <div id="left">
        <table id="id-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>GAIN</th>
                </tr>
            </thead>
            <tbody>
                {% for data_row in datas %}
                <tr onclick="selectID('{{ data_row.id }}')">
                    <td>{{ data_row.id }}</td>
                    <td>{{data_row.gain}}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ==== COLONNA DESTRA: GRAFICO ==== -->
    <div id="right">
        <div id="chart"></div>
    </div>

</div>



<script>
let chart = null;

/* Funzione chiamata quando si clicca una riga */
function selectID(id) {
    loadData(id);
}

async function load_analisi() {
    const response = await fetch(`/analisi`);
    const analisi = await response.json();
    console.log(analisi)
}

/* Carica e visualizza il grafico */
async function loadData(id) {
    const response = await fetch(`/data?id=${id}`);
    const candles = await response.json();

    const seriesData = candles.map(c => ({
        x: new Date(c.t),
        y: [c.o, c.h, c.l, c.c]
    }));

    // Se esiste già un grafico → distruggilo
    if (chart !== null) {
        chart.destroy();
    }

    const options = {
        chart: {
            type: 'candlestick',
            height: 600
        },
        series: [{
            data: seriesData
        }],
        xaxis: {
            type: 'datetime'
        },
        title: {
            text: "ID: " + id,
            align: "center"
        }
    };

    chart = new ApexCharts(document.querySelector("#chart"), options);
    chart.render();
}

/* Carica il primo ID all'avvio */
window.onload = function() {
    const firstRow = document.querySelector("#id-table tbody tr");
    if (firstRow) {
        const firstID = firstRow.children[0].innerText;
        loadData(firstID);
    }
};
</script>

</body>
</html>
